{% extends "base.html" %}

{% block title %}Edit Activity{% endblock %}

{% block content %}
<h1>Edit Activity</h1>
<h4>Topic: {{ topic.name }} | Course: {{ course.name }} - Section {{ section.number }}</h4>
<h5>Format: 
    {% if topic.weight_or_percentage %}
        <span class="badge bg-primary">Percentage-based (must sum to 100%)</span>
    {% else %}
        <span class="badge bg-secondary">Weight-based</span>
    {% endif %}
</h5>

<form method="POST" onsubmit="return validateForm()" style="max-width: 500px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px;">
    <div style="margin-bottom: 15px;">
        <label for="name" style="font-weight: bold;">Activity Name:</label><br>
        <input type="text" name="name" id="name" value="{{ activity.name }}" required style="width: 100%; padding: 8px;">
    </div>
    
    <div style="margin-bottom: 15px;">
        <label for="optional" style="font-weight: bold;">Optional:</label><br>
        <input type="checkbox" name="optional" id="optional" {% if activity.optional_flag %}checked{% endif %}> 
        <span>Check if this activity is optional</span>
        <small class="form-text text-muted d-block">
            Optional activities are not counted if the student doesn't complete them.
            Non-optional activities are counted as 1.0 if not completed.
        </small>
    </div>
    
    {% if topic.weight_or_percentage %}
    <h3>Current Percentages:</h3>
    <ul style="list-style-type: none; padding-left: 0;">
        {% for act in activities if act.id != activity.id %}
        <li style="margin-bottom: 10px;">
            <strong>{{ act.name }}:</strong>
            <input type="number" name="percentages_{{ act.id }}" value="{{ act.weight }}" step="1" min="1" max="100" required style="width: 70px;"> %
        </li>
        {% endfor %}
    </ul>
    <div style="margin-top: 15px;">
        <label for="weight" style="font-weight: bold;">Activity Percentage:</label><br>
        <input type="number" name="weight" id="weight" value="{{ activity.weight }}" step="1" min="1" max="100" required style="width: 100px;"> %
    </div>
    <p style="color: gray; margin-top: 5px;">Total must be exactly 100%</p>
    {% else %}
    <h3>Current Weights:</h3>
    <ul style="list-style-type: none; padding-left: 0;">
        {% for act in activities if act.id != activity.id %}
        <li style="margin-bottom: 5px;">
            <strong>{{ act.name }}:</strong> {{ act.weight }}
        </li>
        {% endfor %}
    </ul>
    <div style="margin-top: 15px;">
        <label for="weight" style="font-weight: bold;">Activity Weight:</label><br>
        <input type="number" step="1" name="weight" id="weight" value="{{ activity.weight }}" required style="width: 100px;">
    </div>
    {% endif %}
    
    <div style="margin-top: 20px; text-align: center;">
        <a href="{{ url_for('list_activities', topic_id=topic.id) }}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">Update Activity</button>
    </div>
</form>

{% if topic.weight_or_percentage %}
<script>
function validateForm() {
    const inputs = document.querySelectorAll("input[type='number'][name^='percentages_']");
    const activityPercentage = parseInt(document.getElementById('weight').value);
    let total = 0;
    inputs.forEach(input => {
        total += parseInt(input.value) || 0;
    });
    total += activityPercentage;
    if (total !== 100) {
        alert("Total percentage must be exactly 100%. Current total: " + total + "%");
        return false;
    }
    return true;
}
</script>
{% endif %}
{% endblock %}